<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¾ APPLEåƒ¹æ ¼POPè¼¸å‡ºç³»çµ± (å…¬é–‹ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- SheetJS ç”¨æ–¼è§£æ Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        /* é è¨­åˆ—å°èƒŒæ™¯åœ–æ¨£å¼ */
        .pop-bg {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* ç´™å¼µæ¨¡æ“¬èˆ‡é è¦½è¨­å®š */
        .a4-sheet {
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 0 auto 20px auto;
            position: relative;
            overflow: hidden;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* A4 å°ºå¯¸å®šç¾© */
        .sheet-portrait { width: 210mm; height: 297mm; }
        .sheet-landscape { width: 297mm; height: 210mm; }

        /* ç¶²æ ¼ä½ˆå±€å®¹å™¨ */
        .grid-container {
            display: grid;
            width: 100%;
            height: 100%;
            padding: 10mm;
            box-sizing: border-box;
            justify-content: center;
            align-content: start;
            gap: 2mm;
        }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card {
            border: 1px dashed #ccc;
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
            background-color: rgba(255,255,255,0.8);
        }

        /* å–®å¼µå¡ç‰‡åˆªé™¤æŒ‰éˆ• */
        .delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        /* æ•´é åˆªé™¤æŒ‰éˆ• */
        .page-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc2626;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .page-delete-btn:hover {
            transform: scale(1.1);
            background: #b91c1c;
        }

        .highlight {
            color: #cc3300;
            vertical-align: baseline;
        }

        /* 1. å°å¡ */
        .card-small {
            width: 85mm;
            height: 55mm;
            padding: 0mm 5mm 8mm 5mm; /* ä¸Š0, å³5, ä¸‹8, å·¦5 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            line-height: 1.1; /* è¡Œé«˜ç¸®å° */
        }
        .card-small .main-text {
            font-size: 12pt;
            font-weight: bold;
            color: #000;
            text-align: left;
        }
        .card-small .highlight {
            color: #cc3300;
            font-size: 18pt;
        }
        .card-small .note {
            font-size: 10pt; /* èª¿æ•´ç‚º 10pt */
            font-weight: normal;
            color: #000;
            margin-top: 0px; /* é–“è·æ­¸é›¶ */
            width: 100%;
        }

        /* 2. ä¸­å¡ */
        .card-medium {
            width: 125mm;
            height: 55mm;
            padding: 0mm 5mm 8mm 5mm; /* ä¸Š0, å³5, ä¸‹8, å·¦5 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            line-height: 1.1;
        }
        .card-medium .main-text {
            font-size: 20pt;
            font-weight: bold;
            color: #000;
            text-align: left;
            vertical-align: baseline;
        }
        .card-medium .highlight {
            font-size: 26pt;
            color: #cc3300;
            vertical-align: baseline;
        }
        .card-medium .note {
            font-size: 14pt;
            font-weight: normal;
            color: #000;
            margin-top: 0px;
            width: 100%;
        }

        /* 3. å¤§å¡ä¿®æ­£ç‰ˆ */
        .card-large {
            width: 185mm;
            height: 65mm;
            /* ä¸Šæ–¹çµ¦ 8mm ç©ºé–“ç¢ºä¿å­—ä¸è¢«åˆ‡ï¼Œåº•éƒ¨ç•™ 2mm */
            padding: 8mm 5mm 2mm 5mm;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .card-large .line-name {
            font-size: 42pt;
            font-weight: bold;
            color: #000;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* æ”¶ç·Šè¡Œé«˜ï¼Œé¿å…ä½”ç”¨å¤ªå¤šå‚ç›´ç©ºé–“ */
            line-height: 1.1; 
            margin-bottom: 1mm;
        }
        .card-large .line-note {
            font-size: 20pt;
            color: #000;
            text-align: right;
            width: 100%;
            line-height: 1.1;
            /* é—œéµï¼šè®“å‚™è¨»ä¸‹æ–¹è‡ªå‹•å»¶ä¼¸ï¼ŒæŠŠåƒ¹æ ¼æ¨åˆ°æœ€åº• */
            margin-bottom: auto; 
        }
        .card-large .line-price {
            font-size: 34pt;
            font-weight: bold;
            text-align: center;
            width: 100%;
            color: #000;
            display: flex;
            justify-content: center;
            /* è®“ä¸åŒå¤§å°çš„å­—åº•éƒ¨å°é½Š */
            align-items: baseline; 
            /* æ”¶ç·Šè¡Œé«˜ */
            line-height: 1; 
        }
        .card-large .highlight {
            font-size: 66pt;
            color: #cc3300;
            /* ç¢ºä¿å¤§æ•¸å­—ä¸æœƒæ’é–‹é¡å¤–é«˜åº¦ */
            line-height: 1; 
        }

        /* é ç¢¼æ¨™ç¤º */
        .page-number {
            position: absolute;
            bottom: 5mm;
            right: 5mm;
            font-size: 10pt;
            color: #999;
        }

        #preview-area {
            transform-origin: top center;
            transition: transform 0.2s;
        }

        /* === åˆ—å°æ ¸å¿ƒä¿®æ­£ === */
        @media print {
            @page { margin: 0; }
            body * { visibility: hidden; }
            .no-print, header, aside, .page-number, .page-delete-btn { display: none !important; }
            html, body {
                width: 100%; height: auto; overflow: visible !important;
                display: block !important; margin: 0 !important; padding: 0 !important; background: white !important;
            }
            main {
                visibility: visible !important; display: block !important; position: static !important;
                margin: 0 !important; padding: 0 !important; width: 100% !important; height: auto !important;
                overflow: visible !important;
            }
            #scroll-container {
                visibility: visible !important; display: block !important; overflow: visible !important;
                margin: 0 !important; padding: 0 !important;
            }
            .grid-container {
                padding-bottom: 0 !important; padding-left: 10mm !important; padding-right: 10mm !important;
                gap: 0.3mm !important; height: auto !important;
            }
            .grid-small { padding-top: 1mm !important; }
            .grid-medium, .grid-large { padding-top: 5mm !important; }
            #preview-area, #preview-area * { visibility: visible !important; }
            #preview-area {
                position: static !important; transform: none !important; width: 100% !important;
                margin: 0 !important; padding: 0 !important; left: 0 !important; top: 0 !important;
            }
            .a4-sheet {
                margin: 0 !important; box-shadow: none !important; border: none !important;
                position: relative !important; left: 0 !important; top: 0 !important; height: auto !important;
                min-height: 200mm; page-break-after: always;
            }
            .a4-sheet:last-of-type { page-break-after: auto !important; page-break-inside: avoid !important; margin-bottom: 0 !important; }
            .card { border: none !important; }
            .delete-btn { display: none !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 z-10 flex items-center justify-between no-print">
        <div class="flex items-center gap-3">
            <!-- åº—è²“å±•ç¤ºå€ -->
            <div class="flex gap-2 mr-2">
                <img src="1.ico" onerror="this.style.display='none'" class="h-10 w-10 rounded-full object-cover border-2 border-blue-100 shadow-sm hover:scale-110 transition-transform duration-200" title="åº—è²“1">
                <img src="2.ico" onerror="this.style.display='none'" class="h-10 w-10 rounded-full object-cover border-2 border-blue-100 shadow-sm hover:scale-110 transition-transform duration-200" title="åº—è²“2">
                <img src="3.ico" onerror="this.style.display='none'" class="h-10 w-10 rounded-full object-cover border-2 border-blue-100 shadow-sm hover:scale-110 transition-transform duration-200" title="åº—è²“3">
                <img src="4.ico" onerror="this.style.display='none'" class="h-10 w-10 rounded-full object-cover border-2 border-blue-100 shadow-sm hover:scale-110 transition-transform duration-200" title="åº—è²“4">
            </div>
            
            <!-- é è¨­ Icon -->
            <img src="icon256.ico" onerror="this.style.display='none'" alt="Logo" class="h-10 w-10 object-contain">
            <h1 class="text-2xl font-bold text-gray-800">APPLEåƒ¹æ ¼POPè¼¸å‡ºç³»çµ±</h1>
        </div>
        
        <div class="text-sm">
            <!-- Instagram é€£çµ -->
             <a href="https://www.instagram.com/tsikkong/?igsh=MTdqYmV6YmNoeGhpZg%3D%3D&utm_source=qr#" target="_blank" class="flex items-center gap-2 text-blue-500 hover:text-blue-700 hover:underline transition-colors font-medium text-sm">
                <i class="fab fa-instagram text-xl"></i>
                <span>æ²’æœ‰è¦æ–—å…§ï¼Œä½†å¯ä»¥é»é€²ä¾†æ”¯æŒä¸€ä¸‹</span>
            </a>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <aside class="w-96 bg-white border-r border-gray-200 flex flex-col p-4 overflow-y-auto no-print shadow-xl z-20">
            
            <!-- å°ºå¯¸é¸æ“‡ -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                <h3 class="font-bold text-gray-700 mb-3">1. é¸æ“‡å°ºå¯¸</h3>
                <div class="space-y-2">
                    <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-blue-50">
                        <input type="radio" name="size" value="small" class="mr-2 w-4 h-4 text-blue-600" checked onchange="changeSize()">
                        <div>
                            <div class="font-bold">å°å¡ (8.5x5.5cm)</div>
                            <div class="text-xs text-gray-500">ç›´å¼A4 | 10å¼µ/é  (2x5)</div>
                        </div>
                    </label>
                    <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-blue-50">
                        <input type="radio" name="size" value="medium" class="mr-2 w-4 h-4 text-blue-600" onchange="changeSize()">
                        <div>
                            <div class="font-bold">ä¸­å¡ (12.5x5.5cm)</div>
                            <div class="text-xs text-gray-500">æ©«å¼A4 | 6å¼µ/é  (2x3)</div>
                        </div>
                    </label>
                    <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-blue-50">
                        <input type="radio" name="size" value="large" class="mr-2 w-4 h-4 text-blue-600" onchange="changeSize()">
                        <div>
                            <div class="font-bold">å¤§å¡ (18.5x6.5cm)</div>
                            <div class="text-xs text-gray-500">ç›´å¼A4 | 4å¼µ/é  (1x4)</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- è³‡æ–™è¼¸å…¥ -->
            <div class="mb-6">
                <h3 class="font-bold text-gray-700 mb-3">2. è¼¸å…¥è³‡æ–™</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold mb-1">å“å</label>
                        <input type="text" id="input-name" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šè²“ç½é ­">
                    </div>
                    <div class="flex gap-2">
                        <div class="w-1/3">
                            <label class="block text-xs font-bold mb-1">çµ„æ•¸ (é¸å¡«)</label>
                            <input type="text" id="input-qty" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="3">
                        </div>
                        <div class="w-2/3">
                            <label class="block text-xs font-bold mb-1">åƒ¹æ ¼</label>
                            <input type="text" id="input-price" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="100">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1">å‚™è¨»</label>
                        <input type="text" id="input-note" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="å”®å®Œç‚ºæ­¢">
                    </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button onclick="addCard()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                        <i class="fas fa-plus mr-1"></i> ç”¢ç”Ÿ
                    </button>
                    <button onclick="copyLast()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">
                        <i class="fas fa-copy mr-1"></i> è¤‡è£½å‰ç­†
                    </button>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="mb-6 border-t pt-4">
                <h3 class="font-bold text-gray-700 mb-3">3. åŠŸèƒ½æ“ä½œ</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openBatchModal()" class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-3 rounded">
                        <i class="fas fa-file-import mr-1"></i> æ‰¹é‡åŒ¯å…¥
                    </button>
                    <button onclick="clearAll()" class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-3 rounded">
                        <i class="fas fa-trash-alt mr-1"></i> å…¨éƒ¨æ¸…é™¤
                    </button>
                </div>
                
                <!-- èƒŒæ™¯è¨­å®š (å”¯è®€æç¤º) -->
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-center">
                    <p class="text-xs text-gray-500 font-bold">
                        <i class="fas fa-image mr-1"></i> èƒŒæ™¯åœ–ç‰‡ï¼šç³»çµ±é è¨­ (background.jpg)
                    </p>
                </div>

                <!-- è‡ªè¨‚å­—å‹è¨­å®š -->
                <div class="mt-4 p-3 bg-purple-50 border border-purple-200 rounded">
                    <label class="block text-xs font-bold mb-2">è‡ªè¨‚å­—å‹è¨­å®š</label>
                    
                    <!-- é¸å–®é¸æ“‡å€ -->
                    <div class="mb-1">
                        <label class="text-xs text-gray-600 mb-1 block">é¸æ“‡è³‡æ–™å¤¾å…§çš„å­—å‹ï¼š</label>
                        <select id="font-selector" onchange="changeLocalFont()" class="w-full border rounded p-1 text-sm mb-1 focus:ring-2 focus:ring-purple-500 outline-none">
                            <!-- JS æœƒè‡ªå‹•å¡«å…¥é¸é … -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- åˆ—å°å€ -->
            <div class="mt-auto bg-gray-800 text-white p-4 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <span>ç›®å‰é æ•¸: <span id="page-count">0</span></span>
                    <span>ç¸½å¡ç‰‡: <span id="card-count">0</span></span>
                </div>
                <button onclick="printPop()" class="w-full bg-white text-gray-900 hover:bg-gray-200 font-bold py-3 px-4 rounded-lg shadow-lg transition flex items-center justify-center text-lg">
                    <i class="fas fa-print mr-2"></i> åˆ—å° POP
                </button>
            </div>
        </aside>

        <!-- å³å´é è¦½å€ -->
        <main class="flex-1 flex flex-col h-full bg-gray-500 relative">
            <!-- é è¦½æ§åˆ¶æ¢ -->
            <div class="bg-gray-700 text-white p-2 flex justify-between items-center shadow z-10 no-print">
                <div class="flex items-center gap-4">
                    <span class="font-bold">é è¦½æ¨¡å¼</span>
                    <div class="flex items-center gap-2">
                        <label class="text-xs">ç¸®æ”¾:</label>
                        <input type="range" min="0.3" max="1.5" step="0.1" value="0.6" oninput="updateZoom(this.value)" class="w-32">
                        <span id="zoom-val" class="text-xs w-8">60%</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs">è·³è‡³é é¢:</label>
                    <input type="number" id="jump-page" min="1" value="1" class="w-16 text-black px-1 rounded text-center">
                    <button onclick="jumpToPage()" class="bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded text-xs">Go</button>
                </div>
            </div>

            <!-- æ»¾å‹•å€åŸŸ -->
            <div class="flex-1 overflow-auto p-8 flex justify-center items-start" id="scroll-container">
                <div id="preview-area" class="flex flex-col gap-8" style="transform: scale(0.6);">
                    <!-- é€™è£¡æœƒå‹•æ…‹ç”Ÿæˆ A4 ç´™å¼µ -->
                </div>
            </div>
        </main>
    </div>

    <!-- æ‰¹é‡åŒ¯å…¥ Modal -->
    <div id="batch-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-xl w-1/2 h-3/4 flex flex-col">
            <h2 class="text-xl font-bold mb-2">æ‰¹é‡åŒ¯å…¥</h2>
            <div class="flex gap-4 mb-4 border-b">
                <div class="pb-2 border-b-2 border-blue-500 font-bold cursor-pointer text-blue-600">æ–‡å­—è¼¸å…¥</div>
                <div class="pb-2 text-gray-500 text-sm self-end ml-auto">æ”¯æ´ Excel (.xls, .xlsx)</div>
            </div>

            <div class="mb-4">
                 <label class="block text-sm font-bold mb-1 text-gray-700">æ–¹å¼ä¸€ï¼šç›´æ¥è²¼ä¸Šæ–‡å­—</label>
                 <p class="text-xs text-gray-500 mb-2">æ ¼å¼ï¼šå“å,çµ„æ•¸,åƒ¹æ ¼,å‚™è¨» (é€—è™Ÿåˆ†éš”)</p>
                 <textarea id="batch-input" class="border p-3 font-mono text-sm w-full h-32 rounded mb-4 focus:ring-2 focus:ring-blue-500" placeholder="è²“ç½é ­,3,100,å”®å®Œç‚ºæ­¢&#10;ç‹—é£¼æ–™,,500,æ–°å“ä¸Šå¸‚"></textarea>
            </div>

            <div class="mb-4 p-4 bg-green-50 rounded border border-green-100">
                <label class="block text-sm font-bold mb-2 text-gray-700">æ–¹å¼äºŒï¼šä¸Šå‚³ Excel æª”æ¡ˆ</label>
                <input type="file" id="excel-file" accept=".xls,.xlsx" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200"/>
                <p class="text-xs text-gray-500 mt-2">ç³»çµ±æœƒè‡ªå‹•æƒæ Excel å…§æ‰€æœ‰å·¥ä½œè¡¨ã€‚è‹¥æœ‰ã€Œå°å‡ºã€æ¬„ä½ï¼Œå‰‡åªåŒ¯å…¥æ•¸å€¼ç‚º 1 çš„è³‡æ–™ï¼›è‹¥ç„¡ï¼Œå‰‡å…¨æ•¸åŒ¯å…¥ã€‚</p>
            </div>

            <div class="flex justify-end gap-2 mt-auto">
                <button onclick="closeBatchModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">å–æ¶ˆ</button>
                <button onclick="processBatch()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">åŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ã€ä½¿ç”¨è€…è¨­å®šå€ã€‘
        // è³‡æ–™å¤¾å…§å¯¦éš›å­˜åœ¨çš„å­—å‹æ¸…å–®
        // ==========================================
        const fontList = [
            { label: 'é è¨­é»‘é«” (Noto Sans TC)', filename: 'default' },
            { label: 'å®‡æ–‡å¤©ç©¹', filename: 'å®‡æ–‡å¤©ç©¹.ttf' },
            { label: 'æ¸…æ¾æ‰‹å¯«é«” 4', filename: 'æ¸…æ¾æ‰‹å¯«é«” 4.ttf' },
            { label: 'æºæ³‰åœ“é«”-b', filename: 'æºæ³‰åœ“é«”-b.otf' },
            { label: 'éœé¶©æ¼«é»‘', filename: 'éœé¶©æ¼«é»‘.ttf' }
        ];
        // ==========================================

        let cards = [];
        let currentSize = 'small';
        // å¼·åˆ¶é è¨­èƒŒæ™¯
        let currentBackgroundImage = 'url("background.jpg")'; 
        let currentFontFamily = '"Noto Sans TC", sans-serif'; 

        const configs = {
            small: {
                name: 'å°å¡', width: 85, height: 55, sheetClass: 'sheet-portrait', rows: 5, cols: 2, limit: 10
            },
            medium: {
                name: 'ä¸­å¡', width: 125, height: 55, sheetClass: 'sheet-landscape', rows: 3, cols: 2, limit: 6
            },
            large: {
                name: 'å¤§å¡', width: 185, height: 65, sheetClass: 'sheet-portrait', rows: 4, cols: 1, limit: 4
            }
        };

        window.onload = function() {
            initFontSelector();
            render();
            updateZoom(0.6);
        };

        // åˆå§‹åŒ–å­—å‹é¸å–®
        function initFontSelector() {
            const selector = document.getElementById('font-selector');
            selector.innerHTML = '';
            fontList.forEach(font => {
                const option = document.createElement('option');
                option.value = font.filename;
                option.text = font.label;
                selector.appendChild(option);
            });
        }

        // åˆ‡æ›æœ¬åœ°å­—å‹
        function changeLocalFont() {
            const selector = document.getElementById('font-selector');
            const filename = selector.value;

            if (filename === 'default') {
                currentFontFamily = '"Noto Sans TC", sans-serif';
                return;
            }

            // å®šç¾©å”¯ä¸€çš„ FontFace åç¨±ï¼Œé¿å…è¡çª
            const fontName = 'LocalFont_' + filename.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');
            const fontUrl = `url("${filename}")`;
            
            // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦å·²ç¶“è¼‰å…¥éé€™å€‹å­—å‹
            const isLoaded = Array.from(document.fonts).some(f => f.family === fontName);

            if (isLoaded) {
                currentFontFamily = `"${fontName}", "Noto Sans TC", sans-serif`;
            } else {
                // å˜—è©¦è¼‰å…¥
                const fontFace = new FontFace(fontName, fontUrl);
                fontFace.load().then(function(loadedFace) {
                    document.fonts.add(loadedFace);
                    currentFontFamily = `"${fontName}", "Noto Sans TC", sans-serif`;
                }).catch(function(error) {
                    // ç‚ºäº†ä¸è®“é è¦½å ±éŒ¯ï¼Œé€™è£¡ä½¿ç”¨ console.log ä»£æ›¿ alert
                    console.log(`æ‰¾ä¸åˆ°æª”æ¡ˆ "${filename}" \nè«‹ç¢ºèªæª”æ¡ˆå·²æ”¾å…¥åŒä¸€è³‡æ–™å¤¾ï¼Œä¸”æª”åå®Œå…¨ä¸€è‡´ï¼`);
                    console.error(error);
                    // å¤±æ•—å‰‡åˆ‡å›é è¨­
                    selector.value = 'default';
                    currentFontFamily = '"Noto Sans TC", sans-serif';
                });
            }
        }

        function changeSize() {
            let selectedSize = '';
            const radios = document.getElementsByName('size');
            for (let r of radios) {
                if (r.checked) {
                    selectedSize = r.value;
                    break;
                }
            }
            if (selectedSize === currentSize) return;

            if (cards.length > 0) {
                // åœ¨é è¦½ç’°å¢ƒä¸­ confirm å¯èƒ½æœƒè¢«é˜»æ“‹ï¼Œé€™è£¡ç°¡åŒ–é‚è¼¯ï¼Œç›´æ¥åˆ‡æ›æˆ–ä½¿ç”¨è‡ªå®šç¾© modal (é€™è£¡ä¿æŒåŸæ¨£)
                if (confirm('åˆ‡æ›å¾Œæœƒæ¸…é™¤è³‡æ–™')) {
                    cards = [];
                    currentSize = selectedSize;
                    render();
                } else {
                    for (let r of radios) {
                        if (r.value === currentSize) {
                            r.checked = true;
                        }
                    }
                }
            } else {
                currentSize = selectedSize;
                render();
            }
        }

        function addCard() {
            const name = document.getElementById('input-name').value.trim();
            const qty = document.getElementById('input-qty').value.trim();
            const price = document.getElementById('input-price').value.trim();
            const note = document.getElementById('input-note').value.trim();

            if (!name || !price) {
                alert('è«‹è‡³å°‘è¼¸å…¥å“åèˆ‡åƒ¹æ ¼ï¼');
                return;
            }

            cards.push({ 
                name, qty, price, note, 
                bg: currentBackgroundImage,
                font: currentFontFamily
            });
            render();
            document.getElementById('input-name').focus();
        }

        function copyLast() {
            if (cards.length === 0) {
                alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯è¤‡è£½');
                return;
            }
            const last = cards[cards.length - 1];
            cards.push({ 
                name: last.name,
                qty: last.qty,
                price: last.price,
                note: last.note,
                bg: currentBackgroundImage,
                font: currentFontFamily
            });
            render();
        }

        function deleteCard(index) {
            cards.splice(index, 1);
            render();
        }

        function deletePage(pageNumber) {
            const config = configs[currentSize];
            const limit = config.limit;
            const startIndex = (pageNumber - 1) * limit;
            cards.splice(startIndex, limit);
            render();
        }

        function clearAll() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¡ç‰‡å—ï¼Ÿ')) {
                cards = [];
                render();
            }
        }

        function render() {
            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = '';
            
            const config = configs[currentSize];
            const totalCards = cards.length;
            
            document.getElementById('card-count').innerText = totalCards;
            const totalPages = Math.ceil(totalCards / config.limit) || 1;
            document.getElementById('page-count').innerText = totalPages;

            let cardIndex = 0;
            for (let i = 1; i <= totalPages; i++) {
                const sheet = document.createElement('div');
                sheet.className = `a4-sheet ${config.sheetClass}`;
                sheet.id = `page-${i}`;

                const pageDelBtn = document.createElement('div');
                pageDelBtn.className = 'page-delete-btn no-print';
                pageDelBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                pageDelBtn.title = 'åˆªé™¤æ•´é ';
                pageDelBtn.onclick = function() {
                    if(confirm(`ç¢ºå®šè¦åˆªé™¤ç¬¬ ${i} é çš„æ‰€æœ‰å¡ç‰‡å—ï¼Ÿ\n(å¾Œé¢çš„å¡ç‰‡æœƒè‡ªå‹•éè£œ)`)) {
                        deletePage(i);
                    }
                };
                sheet.appendChild(pageDelBtn);
                
                const grid = document.createElement('div');
                grid.className = `grid-container grid-${currentSize}`;
                grid.style.gridTemplateColumns = `repeat(${config.cols}, ${config.width}mm)`;
                grid.style.gridTemplateRows = `repeat(${config.rows}, ${config.height}mm)`;

                for (let j = 0; j < config.limit; j++) {
                    if (cardIndex >= totalCards) break;
                    
                    const data = cards[cardIndex];
                    const card = createCardElement(data, cardIndex, currentSize);
                    grid.appendChild(card);
                    
                    cardIndex++;
                }

                const pageNum = document.createElement('div');
                pageNum.className = 'page-number';
                pageNum.innerText = `ç¬¬ ${i} é `;
                
                sheet.appendChild(grid);
                sheet.appendChild(pageNum);
                previewArea.appendChild(sheet);
            }
        }

        function createCardElement(data, index, size) {
            const div = document.createElement('div');
            div.className = `card card-${size} pop-bg`;
            
            div.style.backgroundImage = data.bg || 'url("background.jpg")';
            div.style.fontFamily = data.font || '"Noto Sans TC", sans-serif';

            const delBtn = document.createElement('div');
            delBtn.className = 'delete-btn';
            delBtn.innerHTML = '<i class="fas fa-times"></i>';
            delBtn.onclick = () => deleteCard(index);
            div.appendChild(delBtn);

            if (size === 'small' || size === 'medium') {
                const mainText = document.createElement('div');
                mainText.className = 'main-text';
                let qtyHtml = data.qty ? `<span class="highlight qty-val">${data.qty}</span>å…¥` : '';
                let priceHtml = `<span class="highlight price-val">${data.price}</span>å…ƒ`;
                mainText.innerHTML = `${data.name} ${qtyHtml}${priceHtml}`;
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                noteDiv.innerText = data.note;
                div.appendChild(mainText);
                div.appendChild(noteDiv);
            } else if (size === 'large') {
                const lineName = document.createElement('div');
                lineName.className = 'line-name';
                lineName.innerText = data.name;
                const lineNote = document.createElement('div');
                lineNote.className = 'line-note';
                lineNote.innerText = data.note;
                const linePrice = document.createElement('div');
                linePrice.className = 'line-price';
                let qtyHtml = data.qty ? `<span class="highlight">${data.qty}</span>å…¥` : '';
                let priceHtml = `<span class="highlight">${data.price}</span>å…ƒ`;
                linePrice.innerHTML = `ç‰¹åƒ¹${qtyHtml}${priceHtml}`;
                div.appendChild(lineName);
                div.appendChild(lineNote);
                div.appendChild(linePrice);
            }
            return div;
        }

        function updateZoom(val) {
            document.getElementById('preview-area').style.transform = `scale(${val})`;
            document.getElementById('zoom-val').innerText = Math.round(val * 100) + '%';
        }

        function jumpToPage() {
            const page = document.getElementById('jump-page').value;
            const target = document.getElementById(`page-${page}`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('æ‰¾ä¸åˆ°è©²é é¢');
            }
        }

        function openBatchModal() {
            document.getElementById('batch-modal').classList.remove('hidden');
            document.getElementById('batch-modal').classList.add('flex');
        }
        function closeBatchModal() {
            document.getElementById('batch-modal').classList.add('hidden');
            document.getElementById('batch-modal').classList.remove('flex');
            document.getElementById('excel-file').value = ''; 
        }

        function processBatch() {
            const fileInput = document.getElementById('excel-file');
            const textInput = document.getElementById('batch-input');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // éæ­·æ‰€æœ‰å·¥ä½œè¡¨
                    let addedCount = 0;
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        // ä½¿ç”¨ { defval: '' } å¼·åˆ¶æ‰€æœ‰æ¬„ä½å‡ºç¾ï¼Œè§£æ±ºç¬¬ä¸€åˆ—ç©ºå€¼å°è‡´æ¬„ä½éºå¤±çš„å•é¡Œ
                        const json = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                        
                        if (json.length === 0) return;

                        let hasPrintColumn = false;
                        // æª¢æŸ¥è©²å·¥ä½œè¡¨æ˜¯å¦æœ‰ "å°å‡º" æ¬„ä½
                        if (json.length > 0) {
                            const firstRowKeys = Object.keys(json[0]);
                            for (const key of firstRowKeys) {
                                if (key.replace(/\s/g, '').includes('å°å‡º')) {
                                    hasPrintColumn = true;
                                    break;
                                }
                            }
                        }

                        json.forEach(row => {
                            let name = '', qty = '', price = '', note = '';
                            let printValue = null;

                            for (const key in row) {
                                const cleanKey = key.replace(/\s/g, '');
                                if (cleanKey.includes('å“å')) name = row[key];
                                else if (cleanKey.includes('çµ„æ•¸')) qty = row[key];
                                else if (cleanKey.includes('åƒ¹æ ¼')) price = row[key];
                                else if (cleanKey.includes('å‚™è¨»')) note = row[key];
                                else if (cleanKey.includes('å°å‡º')) printValue = row[key];
                            }

                            let shouldImport = true;
                            // å¦‚æœæœ‰ "å°å‡º" æ¬„ä½ï¼Œå¿…é ˆç‚º 1 æ‰å°ï¼›å¦å‰‡é è¨­å°å‡º
                            if (hasPrintColumn) {
                                // åš´æ ¼æª¢æŸ¥ï¼šè½‰æˆå­—ä¸²å¾Œå»é™¤ç©ºç™½ï¼Œå¿…é ˆç­‰æ–¼ '1'
                                if (String(printValue).trim() !== '1') {
                                    shouldImport = false;
                                }
                            }

                            if (shouldImport && name) {
                                cards.push({ 
                                    name: String(name).trim(), 
                                    qty: qty ? String(qty).trim() : '', 
                                    price: price ? String(price).trim() : '', 
                                    note: note ? String(note).trim() : '',
                                    bg: currentBackgroundImage,
                                    font: currentFontFamily
                                });
                                addedCount++;
                            }
                        });
                    });
                    
                    finishBatch(addedCount);
                };
                reader.readAsArrayBuffer(file);
            } else {
                const text = textInput.value;
                const lines = text.split('\n');
                let addedCount = 0;
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const parts = line.split(/[,ï¼Œ]/);
                    if (parts.length >= 1) {
                        const name = parts[0].trim();
                        const qty = parts[1] ? parts[1].trim() : '';
                        const price = parts[2] ? parts[2].trim() : '';
                        const note = parts[3] ? parts[3].trim() : '';
                        if (name && (price || parts.length > 2)) {
                            cards.push({ 
                                name, qty, price, note,
                                bg: currentBackgroundImage,
                                font: currentFontFamily
                            });
                            addedCount++;
                        }
                    }
                });
                finishBatch(addedCount);
            }
        }

        function finishBatch(count) {
            if (count > 0) {
                render();
                closeBatchModal();
                document.getElementById('batch-input').value = '';
                alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™`);
            } else {
                alert('æ ¼å¼éŒ¯èª¤æˆ–ç„¡è³‡æ–™');
            }
        }

        function printPop() {
            let printStyle = document.getElementById('print-style');
            if (!printStyle) {
                printStyle = document.createElement('style');
                printStyle.id = 'print-style';
                document.head.appendChild(printStyle);
            }

            if (currentSize === 'medium') {
                printStyle.innerHTML = `
                    @media print { 
                        @page { size: landscape; margin: 0; } 
                    }
                `;
                alert("è«‹ç¢ºèªå°è¡¨æ©Ÿè¨­å®šç‚ºã€Œæ©«å‘ã€ä»¥ç²å¾—æœ€ä½³æ•ˆæœ");
            } else {
                printStyle.innerHTML = `
                    @media print { 
                        @page { size: portrait; margin: 0; } 
                    }
                `;
            }
            window.print();
        }

        document.getElementById('input-note').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addCard();
            }
        });
    </script>
</body>
</html>
